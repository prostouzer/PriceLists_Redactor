@using PriceLists_Redactor.Models
@model PriceLists_Redactor.Models.ViewModels.PriceListAndColumnsViewModel

@{
    ViewBag.Title = "Create";
}

<h2>Добавить новый прайс-лист</h2>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <table>
        <tr>
            <td>
                @Html.EditorFor(model => model.PriceList.Name, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.PriceList.Name, "", new { @class = "text-danger" })
            </td>
            <td>
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            </td>
            <td>
                <button class="btn btn-default" id="addNewPriceListBtn" type="button">Добавить</button>
            </td>
        </tr>
    </table>

    <table class="table" align="center">
        <thead>
        <th>№ колонки</th>
        <th>Данные</th>
        <th>Тип данных</th>
        </thead>
        <tbody id="columnsTBody">
        </tbody>
    </table>
    <button class="btn btn-md btn-primary" id="addNewColumnBtn" type="button">Новая колонка</button>
}

<div>
    @Html.ActionLink("Back to List", "Index")
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        var rowIndex = 0;
        $("#addNewColumnBtn").on('click',
            function() {
                $('#columnsTBody').append(`<tr id="R${++rowIndex}">
                    <td><p>Колонка №${rowIndex}</p></td>
                    <td><input type="text" id="HeaderText"></td>
                    <td>
                    <select id="dataTypeSelect">
                    <option>Однострочный текст</option>
                    <option>Многострочный текст</option>
                    <option>Логическое значение</option>
                    <option>Число</option>
                    </select>
                    </td>
                    <td><button class="btn btn-danger remove" type="button">Удалить</button></td>
                </tr>`);
            });

        $('#columnsTBody').on('click',
            '.remove',
            function() {

                // Все элементы впереди текущей удаляемой строки
                var child = $(this).closest('tr').nextAll();

                // Проход по всем следующим строкам и изменение их id
                child.each(function() {

                    // Получение id <tr>
                    var id = $(this).attr('id');

                    // Получение ячейки с id
                    var index = $(this).children('.row-index').children('p');

                    // Извлечение id строки
                    var dig = parseInt(id.substring(1));

                    // Изменение ячейки номера строки
                    index.html(`Колонка №${dig - 1}`);

                    // Изменение id строки
                    $(this).attr('id', `R${dig - 1}`);
                });

                // Удаление текущей строки
                $(this).closest('tr').remove();

                rowIndex--;
            });
    </script>
    <script>
        $("#addNewPriceListBtn").on('click',
            function() {
                var columns = new Array();
                columns.price_list = @Model.PriceList;
                $("#columnsTBody TR").each(function() {
                    var currentRow = $(this);
                    var currentRowColumns = {};
                    columns.header_text = currentRow.find("td").eq(1).html();
                    columns.data_type = currentRow.find("td").eq(2).html();
                    columns.push(currentRowColumns);
                });

                $.ajax({
                    type: "POST",
                    url: "/PriceLists/Create",
                    data: JSON.stringify(columns),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function() {
                        alert("SUCCESS");
                    }
                });
            });

    </script>
}
